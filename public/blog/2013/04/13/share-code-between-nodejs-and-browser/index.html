
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Share code between Node.js and browser - Thinking in Crowd / 鹄思乱想</title>
  <meta name="author" content="鹄思乱想">

  
  <meta name="description" content="Background When you are writing a Node.js based web application, it comes to a demand to share code between Node.js and browser because both the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.thinkingincrowd.me/blog/2013/04/13/share-code-between-nodejs-and-browser/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Thinking in Crowd / 鹄思乱想" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37378953-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Thinking in Crowd / 鹄思乱想</a></h1>
  
    <h2>Swan flying in the immense sky</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.thinkingincrowd.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/tags">Tags</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Share Code Between Node.js and Browser</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-13T12:59:00+08:00" pubdate data-updated="true">Apr 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>Background</h2>

<p>When you are writing a Node.js based web application, it comes to a demand to share code between Node.js and browser because both the frontend and backend are written in JavaScript.  Some utility APIs, such as validation, data processing, are the common cases.</p>

<p>The philosophy of organizing code in Node.js, current trend also, is modularization.  Each module file has its own execution context, requires its dependent APIs from other modules and publishes its own APIs out for other modules.</p>

<p>Hence, the code sharing between Node.js and browser requires the code to be used as the same way in browser.</p>

<h2>Situations and Solutions</h2>

<p>Things work differently regarding the JS and modules loading mechanism.  Because in browser, it works asynchronously while in Node.js it is synchronous.  In browser, we cannot directly do inline require like Node.js:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">xxx</span><span class="p">;</span>
</span><span class='line'><span class="nx">a</span><span class="p">.</span><span class="nx">foo</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">b</span><span class="p">.</span><span class="nx">bar</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are two kinds of situations:</p>

<h3>Modularization already realized for browser code</h3>

<p>If you have already modularized your JS code for browser and used some AMD / CMD script loader, such as <a href="http://requirejs.org/">RequireJS</a>, or <a href="http://seajs.org/">SeaJS</a>, you might expect your life would be easier.  However, this is not the case.</p>

<p>The require must be like below in order to make sure all dependent modules to be loaded successfully and then execute the code which uses them.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">define</span><span class="p">([</span><span class="s1">&#39;./b&#39;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">xxx</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">a</span><span class="p">.</span><span class="nx">foo</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">b</span><span class="p">.</span><span class="nx">bar</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">bla</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;bla&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that there is quite some syntax different between Node.js style and the AMD / CMD one in browser.</p>

<p>To overcome this incompatibility, there are two main approaches.</p>

<ul>
<li><p>Directly add boilerplate code in one side to fit the other</p>

<ol>
<li>Some sample manual boilerplate code and also more explanation can be found <a href="http://www.2ality.com/2011/11/module-gap.html">here</a>.</li>
<li><a href="https://github.com/ajaxorg/node-amd-loader">node-amd-loader</a>: Add one extra line in Node.js module to load AMD style module.</li>
<li>The <a href="https://github.com/jrburke/amdefine">amdefine</a> for RequireJS: Special boilerplate code in Node.js module and then can be stripped out by <a href="https://github.com/jrburke/amdefine#optimizer">RequireJS Optimizer</a>.</li>
</ol>
</li>
<li><p>Build process to handle the boilerplate</p>

<ol>
<li><a href="https://github.com/substack/node-browserify">browserify</a>: Recursively analyze all the <code>require()</code> calls in your app in order to build a bundle you can serve up to the browser in a single <code>&lt;script&gt;</code> tag.</li>
<li><a href="https://github.com/medikoo/modules-webmake">modules-webmake</a>: Bundle CommonJS/Node.js modules for web browsers.</li>
<li><a href="https://github.com/kenspirit/webassemble">webassemble</a>: Based on modules-webmake.  Auto bundle CommonJS/Node.js packages for web browsers.</li>
</ol>
</li>
</ul>


<p>Personally, I prefer introducing extra build process to handle the boilerplate for me.</p>

<p>The advantages of build process boilerplate are:</p>

<ol>
<li>Boilerplate code is brittle and subject to change.  Adding it to every file makes future change harder.  If some build process can automatically remove them, why not use the build process to automatically add them?</li>
<li>Modularization is good but for production environment in browser, it is always better to minimize network request to load JS file.  Most of the time, module files are bundled into single package for one call.  If build process need to be introduced to handle it, it would be great to integrate sharing logic into it also.</li>
<li>If the boilerplate is introduced in build process, it is better to discover potential error during development cycle instead of last minute preproduction testing.</li>
</ol>


<p>You may have concern on effectiveness during development cycle.  However, if you can make good use of a good IDE, say <a href="http://www.sublimetext.com/">Sublime Text</a> and some task runner, say <a href="http://gruntjs.com/">Grunt</a>, it&#8217;s just a couple of seconds&#8217; waiting after a hotkey command after saving your JS file in IDE.  It might just be the time you switch from IDE to browser and press F5.</p>

<h3>Legacy or namespace browser code style</h3>

<p>Although it&#8217;s seldom the case that when you are using such hot tech of Node.js but still need to stick to the old style in browser, it&#8217;s actually easier to share your Node.js code under this circumstance.</p>

<p>The webmake and webassemble mentioned above is easy to bundle your modules under global or a particular namespace.</p>

<p>So, what is my favorite choice?  Write the Node.js style code and share them to browser by webassemble.  Why not webmake?  Because the webassemble is made by me. :P</p>

<p>So tell me what is yours.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">鹄思乱想</span></span>

      








  


<time datetime="2013-04-13T12:59:00+08:00" pubdate data-updated="true">Apr 13<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/sword/'>Sword</a>
  
</span>


      

<span class="tags">
  
    <a class='tag' href='/tags/amd/'>AMD</a>, <a class='tag' href='/tags/javascript/'>Javascript</a>, <a class='tag' href='/tags/modularization/'>Modularization</a>, <a class='tag' href='/tags/nodejs/'>NodeJS</a>, <a class='tag' href='/tags/webassemble/'>Webassemble</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/02/13/review-on-book-lean-startup-and-movie-lincoln-and-the-vow/" title="Previous Post: 读 Lean Startup 和观电影 Lincoln，电影 The VOW 后感">&laquo; 读 Lean Startup 和观电影 Lincoln，电影 The VOW 后感</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/04/16/can-i-make-13-billion-in-20-months/" title="Next Post: 我能否20个月赚130亿?">我能否20个月赚130亿? &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/16/can-i-make-13-billion-in-20-months/">我能否20个月赚130亿?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/13/share-code-between-nodejs-and-browser/">Share code between Node.js and browser</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/13/review-on-book-lean-startup-and-movie-lincoln-and-the-vow/">读 Lean Startup 和观电影 Lincoln，电影 The VOW 后感</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/05/2013-retrospect-and-goal-setting/">2013 Retrospect and Goal Setting</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/02/expression-in-angularjs-must-be-idempotent-and-for-multiple-calls/">Expression in AngularJS must be idempotent and for multiple calls</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/30/string-interpolation-should-not-be-used-with-class-directive-in-angularjs/">String interpolation should not be used with Class Directive in AngularJS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/03/widely-misunderstood-naming-convention-the-hungarian/">被广泛误解的匈牙利命名法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/01/why-i-start-blogging-and-in-english/">为什么开始写技术博客, 并且还是用英语?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/25/ued-in-my-pet-project-take-time-part-1/">UED in my pet project - Take Time (Part 1)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/24/my-practices-on-time-management/">My practices on Time Management</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/life'>Life (6)</a></li><li><a href='/blog/categories/sword'>Sword (15)</a></li><li><a href='/blog/categories/think'>Think (23)</a></li></ul>
</section>
<section>
  <h1>Tag Cloud</h1>
  <ul class="tag-cloud">
    <li><a style="font-size: 60%" href="/tags/amd/">AMD</a></li>
<li><a style="font-size: 60%" href="/tags/adapt/">Adapt</a></li>
<li><a style="font-size: 90%" href="/tags/angularjs/">AngularJS</a></li>
<li><a style="font-size: 60%" href="/tags/blogging/">Blogging</a></li>
<li><a style="font-size: 60%" href="/tags/book/">Book</a></li>
<li><a style="font-size: 90%" href="/tags/change/">Change</a></li>
<li><a style="font-size: 108%" href="/tags/coding/">Coding</a></li>
<li><a style="font-size: 60%" href="/tags/connect/">Connect</a></li>
<li><a style="font-size: 60%" href="/tags/db/">DB</a></li>
<li><a style="font-size: 90%" href="/tags/design/">Design</a></li>
<li><a style="font-size: 90%" href="/tags/destiny/">Destiny</a></li>
<li><a style="font-size: 90%" href="/tags/directive/">Directive</a></li>
<li><a style="font-size: 60%" href="/tags/excel/">Excel</a></li>
<li><a style="font-size: 130%" href="/tags/extjs/">ExtJs</a></li>
<li><a style="font-size: 90%" href="/tags/gtd/">GTD</a></li>
<li><a style="font-size: 60%" href="/tags/goal/">Goal</a></li>
<li><a style="font-size: 60%" href="/tags/health/">Health</a></li>
<li><a style="font-size: 60%" href="/tags/jawr/">JAWR</a></li>
<li><a style="font-size: 121%" href="/tags/jasmine/">Jasmine</a></li>
<li><a style="font-size: 161%" href="/tags/javascript/">Javascript</a></li>
<li><a style="font-size: 121%" href="/tags/management/">Management</a></li>
<li><a style="font-size: 90%" href="/tags/maven/">Maven</a></li>
<li><a style="font-size: 60%" href="/tags/modularization/">Modularization</a></li>
<li><a style="font-size: 60%" href="/tags/mongodb/">MongoDB</a></li>
<li><a style="font-size: 121%" href="/tags/mood/">Mood</a></li>
<li><a style="font-size: 108%" href="/tags/nodejs/">NodeJS</a></li>
<li><a style="font-size: 60%" href="/tags/poi/">POI</a></li>
<li><a style="font-size: 60%" href="/tags/performance/">Performance</a></li>
<li><a style="font-size: 60%" href="/tags/pomodoro/">Pomodoro</a></li>
<li><a style="font-size: 90%" href="/tags/productivity/">Productivity</a></li>
<li><a style="font-size: 165%" href="/tags/retrospect/">Retrospect</a></li>
<li><a style="font-size: 60%" href="/tags/string-interpolation/">String interpolation</a></li>
<li><a style="font-size: 60%" href="/tags/stuff/">Stuff</a></li>
<li><a style="font-size: 90%" href="/tags/time-management/">Time Management</a></li>
<li><a style="font-size: 108%" href="/tags/trip/">Trip</a></li>
<li><a style="font-size: 60%" href="/tags/ued/">UED</a></li>
<li><a style="font-size: 60%" href="/tags/ui/">UI</a></li>
<li><a style="font-size: 121%" href="/tags/unittest/">UnitTest</a></li>
<li><a style="font-size: 60%" href="/tags/webassemble/">Webassemble</a></li>
<li><a style="font-size: 60%" href="/tags/weblogic/">Weblogic</a></li>
<li><a style="font-size: 60%" href="/tags/i18n/">i18n</a></li>
<li><a style="font-size: 60%" href="/tags/ngclass/">ngClass</a></li>
<li><a style="font-size: 60%" href="/tags/ngrepeat/">ngRepeat</a></li>

  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/kenspirit">@kenspirit</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'kenspirit',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
    <h1>Weibo</h1>
    <iframe id="sina_widget_1730265332" style="width:100%; height:500px;" frameborder="0" scrolling="no" src="http://v.t.sina.com.cn/widget/widget_blog.php?uid=1730265332&height=500&skin=wd_01&showpic=1"></iframe>
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/chengusky@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - 鹄思乱想 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'thinkingincrowd';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.thinkingincrowd.me/blog/2013/04/13/share-code-between-nodejs-and-browser/';
        var disqus_url = 'http://www.thinkingincrowd.me/blog/2013/04/13/share-code-between-nodejs-and-browser/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
