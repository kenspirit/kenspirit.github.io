
 <!DOCTYPE HTML>
<html >
<head>
  <script data-ad-client="ca-pub-3734008573442765" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <meta charset="UTF-8">
  
    <title>Broadway Source Reading (Part 5 - Subscription &amp; Concurrency) | Thinking in Crowd / 鹄思乱想</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="鹄思乱想">
    
    <meta name="description" content="At the beginning of this interesting article about Broadway’s concurrency, it said:

Every producer will try to satisfy the demand of every processor.">
    
    
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="kenspirit" />
    <meta name="twitter:title" content="Broadway Source Reading (Part 5 - Subscription &amp; Concurrency) | Thinking in Crowd / 鹄思乱想" />
      
    
    
    <link rel="alternate" href="/atom.xml" title="Thinking in Crowd / 鹄思乱想" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/qmark.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/qmark.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Thinking in Crowd / 鹄思乱想" title="Thinking in Crowd / 鹄思乱想"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Thinking in Crowd / 鹄思乱想">Thinking in Crowd / 鹄思乱想</a></h1>
				<h2 class="blog-motto">Swan flying in the immense sky</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/about">About</a></li>
					
						<li><a href="/algorithm">Algorithm</a></li>
					
						<li><a href="/kanban">Kanban</a></li>
					
						<li><a href="/nodeppt">Slideshare</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:www.thinkingincrowd.me">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2021/10/04/broadway-source-reading-part-5-subscription-and-concurrency/" title="Broadway Source Reading (Part 5 - Subscription &amp; Concurrency)" itemprop="url">Broadway Source Reading (Part 5 - Subscription &amp; Concurrency)</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://plus.google.com/108764880042816550000?rel=author" title="鹄思乱想" target="_blank" itemprop="author">鹄思乱想</a>
    </p>
  <p class="article-time">
    <time datetime="2021-10-04T13:26:21.000Z" itemprop="datePublished">Oct 4 2021</time>
    Updated:<time datetime="2022-09-04T13:03:03.491Z" itemprop="dateModified">Sep 4 2022</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-the-subscription-is-done"><span class="toc-number">1.</span> <span class="toc-text">How the subscription is done?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Distribution-Logic-on-Biggest-Demand"><span class="toc-number">2.</span> <span class="toc-text">Distribution Logic on Biggest Demand</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unexpected-Subscription-and-Demand-Distribution"><span class="toc-number">3.</span> <span class="toc-text">Unexpected Subscription and Demand Distribution</span></a></li></ol>
		</div>
		
		<p>At the beginning of this interesting <a target="_blank" rel="noopener" href="https://dockyard.com/blog/2021/06/24/tuning-broadway-rabbitmq-pipelines-for-latency?utm_medium=email&utm_source=elixir-radar">article</a> about Broadway’s concurrency, it said:</p>
<blockquote>
<p><strong>Every producer will try to satisfy the demand of every processor.</strong> If a processor asks for two messages and there are two producers, the processor may get four messages. Since it can only process them one at a time, the others will sit in its process mailbox until it’s ready for them.</p>
</blockquote>
<p>Where is the source code supporting this statement?</p>
<p>In my blog about <a href="https://www.thinkingincrowd.me/2021/06/19/broadway-source-reading-processor/">Processor</a>, there are several key points in the Startup Call Sequence Flow and the Pipeline Diagram:</p>
<ol>
<li>ProcessorStage <code>subscribe</code> to Producer during startup.  </li>
<li>ProcessorStage immediately <code>ask</code> events from Producer after subscription and <code>ask</code> recursively.  </li>
<li><code>DemandDispatcher</code> coordinates between the Producer and Processor.</li>
</ol>
<h2 id="How-the-subscription-is-done"><a href="#How-the-subscription-is-done" class="headerlink" title="How the subscription is done?"></a>How the subscription is done?</h2><p>In <code>Subscriber.init/1</code>, below statement tells us that <strong>every consumer process will subscribe to all producer processes randomly and ask for events</strong>.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># We always subscribe in random order so the load is balanced across consumers.</span></span><br><span class="line">names |&gt; <span class="title class_">Enum</span>.shuffle() |&gt; <span class="title class_">Enum</span>.each(&amp;subscribe(&amp;<span class="number">1</span>, state))</span><br></pre></td></tr></table></figure>

<h2 id="Distribution-Logic-on-Biggest-Demand"><a href="#Distribution-Logic-on-Biggest-Demand" class="headerlink" title="Distribution Logic on Biggest Demand"></a>Distribution Logic on Biggest Demand</h2><p>Based on the documentation, the <code>DemandDispatcher</code> is:  </p>
<blockquote>
<ul>
<li><code>GenStage.DemandDispatcher</code> - dispatches the given batch of events to the consumer with the biggest demand in a FIFO ordering. This is the default dispatcher.</li>
</ul>
</blockquote>
<p>During startup, the initial <code>dispatcher_state</code> of the Dispatcher is set to <code>&#123;[], 0, nil&#125;</code>.  Once there is a processor subscribed to the producer, its state <code>&#123;0, pid, ref&#125;</code> is added to the last of the <code>demands</code> list.  </p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span></span>(_opts) <span class="keyword">do</span></span><br><span class="line">  &#123;<span class="symbol">:ok</span>, &#123;[], <span class="number">0</span>, <span class="literal">nil</span>&#125;&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@doc</span> <span class="literal">false</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">subscribe</span></span>(_opts, &#123;pid, ref&#125;, &#123;demands, pending, max&#125;) <span class="keyword">do</span></span><br><span class="line">  &#123;<span class="symbol">:ok</span>, <span class="number">0</span>, &#123;demands ++ [&#123;<span class="number">0</span>, pid, ref&#125;], pending, max&#125;&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>When the Processor <code>ask</code> for events after subscription, the Dispatcher’s <code>ask/3</code> function is called:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ask</span></span>(counter, &#123;pid, ref&#125;, &#123;demands, pending, max&#125;) <span class="keyword">do</span></span><br><span class="line">  max = max || counter</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Omitted demand checking for brevity</span></span><br><span class="line"></span><br><span class="line">  &#123;current, demands&#125; = pop_demand(ref, demands)</span><br><span class="line">  demands = add_demand(current + counter, pid, ref, demands)</span><br><span class="line"></span><br><span class="line">  already_sent = min(pending, counter)</span><br><span class="line">  &#123;<span class="symbol">:ok</span>, counter - already_sent, &#123;demands, pending - already_sent, max&#125;&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">add_demand</span></span>(counter, pid, ref, [&#123;c, _, _&#125; | _] = demands) <span class="keyword">when</span> counter &gt; c <span class="keyword">do</span></span><br><span class="line">  [&#123;counter, pid, ref&#125; | demands]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">add_demand</span></span>(counter, pid, ref, [demand | demands]) <span class="keyword">do</span></span><br><span class="line">  [demand | add_demand(counter, pid, ref, demands)]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">add_demand</span></span>(counter, pid, ref, []) <span class="keyword">when</span> is_integer(counter) <span class="keyword">do</span></span><br><span class="line">  [&#123;counter, pid, ref&#125;]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">pop_demand</span></span>(ref, demands) <span class="keyword">do</span></span><br><span class="line">  &#123;&#123;current, _pid, ^ref&#125;, rest&#125; = <span class="title class_">List</span>.keytake(demands, ref, <span class="number">2</span>)</span><br><span class="line">  &#123;current, rest&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Right after subscription, the <code>counter</code> passed in here is the <strong>max_demand</strong> of the Processor.  <code>pop_demand/2</code> finds out the current pending demand for this specific consumer, and then <code>add_demand/4</code>, assuming <code>demands</code> a sorted list of highest demand on the left, adds the current request count to its pending demand, loops through all other consumers and inserts it to the right position.  </p>
<h2 id="Unexpected-Subscription-and-Demand-Distribution"><a href="#Unexpected-Subscription-and-Demand-Distribution" class="headerlink" title="Unexpected Subscription and Demand Distribution"></a>Unexpected Subscription and Demand Distribution</h2><p>How many events does one Producer get?  How events are distributed across Processors?</p>
<p>RabbitMQ’s <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/consumer-prefetch.html">Consumer Prefetch</a> configuration sets the <code>global</code> flag to <code>false</code> as default value and that means the <code>:prefetch_count</code> option is applied to each Producer process (one RabbitMQ consumer) level.  That means when we set the Producer’s <code>:concurrency</code> to <code>10</code>, <code>:prefetch_count</code> to <code>1</code>, if the RabbitMQ has <code>10</code> messages, every Producer should have <code>1</code> message in theory.</p>
<p>According to my blog about <a href="http://www.thinkingincrowd.me/2021/05/07/broadway-source-reading-producer/">producer</a>, we know that RabbitMQ Producer does nothing on <code>handle_demand/2</code> and it returns an <code>[]</code>.  The events should be delivered in <code>handle_info/2</code> whenever the RabbitMQ pushes the message to the Producer.  That article’s tracking on <code>ask</code> function call actually does not reflect the event distribution reality because <code>ask</code> is called recursively.  They should happen to see so because they also added debug log in <code>handle_info/2</code>.  </p>
<p>According to the Call Sequence Flow and source code, GenStage’s <code>dispatch_events/3</code> and DemandDispatcher’s <code>dispatch/2</code> should be called.  The DemandDispatcher splits the events based on the count asked by the Processor, dispatches to the first Processor in <code>demands</code> list and rearranging the <code>demands</code> list afterwards.  </p>
<p>As the <code>handle_info/2</code> of Broadway RabbitMQ Producer passes one event to one Processor at a time, if every producer gets <code>1</code> message, and the random subscription makes the <code>demands</code> list random, the outcome should be several random Processors got <code>1</code> or <code>2</code> message.  </p>
<p>However, after I cloned the <a target="_blank" rel="noopener" href="https://github.com/nathanl/broadway_rabbitmq_experiment">experiment project</a> from that article, added some debug messages into the dependency library <code>GenStage</code>, <code>Broadway</code>, some unexpected behavior occurs.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pipeline</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_link</span></span>(_opts) <span class="keyword">do</span></span><br><span class="line">  <span class="title class_">Broadway</span>.start_link(</span><br><span class="line">    __MODULE__,</span><br><span class="line">    <span class="symbol">name:</span> __MODULE__,</span><br><span class="line">    <span class="symbol">producer:</span> [</span><br><span class="line">      <span class="symbol">module:</span></span><br><span class="line">        &#123;<span class="title class_">BroadwayRabbitMQ</span>.<span class="title class_">Producer</span>,</span><br><span class="line">         <span class="symbol">queue:</span> <span class="title class_">Foo</span>.env!(<span class="symbol">:queue_name</span>),</span><br><span class="line">         <span class="symbol">connection:</span> <span class="title class_">Foo</span>.conn_options(),</span><br><span class="line">         <span class="symbol">qos:</span> [</span><br><span class="line">           <span class="comment"># this should never be less than @processor_concurrency</span></span><br><span class="line">           <span class="comment"># or else the processors won&#x27;t all get messages</span></span><br><span class="line">           <span class="symbol">prefetch_count:</span> <span class="number">1</span></span><br><span class="line">         ],</span><br><span class="line">         <span class="symbol">on_failure:</span> <span class="symbol">:reject</span>&#125;,</span><br><span class="line">      <span class="comment"># concurrency: 1, # correct behavior</span></span><br><span class="line">      <span class="symbol">concurrency:</span> <span class="number">10</span>, <span class="comment"># try this for poor performance</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="symbol">processors:</span> [</span><br><span class="line">      <span class="symbol">default:</span> [</span><br><span class="line">        <span class="symbol">concurrency:</span> <span class="number">10</span>,</span><br><span class="line">        <span class="symbol">max_demand:</span> <span class="number">1</span></span><br><span class="line">      ]</span><br><span class="line">    ]</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Broadway.Topology.Subscriber.init/1</span></span><br><span class="line"></span><br><span class="line">shuffled_names = names |&gt; <span class="title class_">Enum</span>.shuffle()</span><br><span class="line"><span class="title class_">IO</span>.inspect(<span class="string">&quot;Processor <span class="subst">#&#123;inspect(self())&#125;</span> subscribe to Producer <span class="subst">#&#123;inspect(<span class="title class_">Process</span>.whereis(<span class="title class_">Enum</span>.at(shuffled_names, <span class="number">0</span>)))&#125;</span> first&quot;</span>)</span><br><span class="line"><span class="title class_">Enum</span>.each(shuffled_names, &amp;subscribe(&amp;<span class="number">1</span>, state))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># GenStage.DemandDispatcher.subscribe/2</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">IO</span>.inspect(<span class="string">&quot;Subscribed <span class="subst">#&#123;inspect(self())&#125;</span> from <span class="subst">#&#123;inspect(pid)&#125;</span>&quot;</span>)</span><br><span class="line">&#123;<span class="symbol">:ok</span>, <span class="number">0</span>, &#123;demands ++ [&#123;<span class="number">0</span>, pid, ref&#125;], pending, max&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># GenStage.DemandDispatcher.dispatch_demand/3</span></span><br><span class="line"></span><br><span class="line">pids = <span class="title class_">Enum</span>.map(demands, <span class="keyword">fn</span> &#123;_, other_pid, _&#125; -&gt;</span><br><span class="line">  other_pid</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"><span class="title class_">IO</span>.inspect(<span class="string">&quot;Producer <span class="subst">#&#123;inspect(self())&#125;</span> sends message to consumer <span class="subst">#&#123;inspect(pid)&#125;</span> out of <span class="subst">#&#123;inspect(pids)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>When I started the application, the debug message shows that each Processor indeed try to subscribe to producer randomly.  However, if you examine the output below carefully, you can find that <strong>the actual moment of the subscription in GenStage process (debug logs like “Subscribed xxxx from yyyy”), which is also constructing the <code>demands</code> list, happens sequentially on each Producer and Processor</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">&quot;Processor #PID&lt;0.344.0&gt; subscribe to Producer #PID&lt;0.341.0&gt; first&quot;</span><br><span class="line">&quot;Processor #PID&lt;0.345.0&gt; subscribe to Producer #PID&lt;0.333.0&gt; first&quot;</span><br><span class="line">&quot;Processor #PID&lt;0.346.0&gt; subscribe to Producer #PID&lt;0.336.0&gt; first&quot;</span><br><span class="line">&quot;Processor #PID&lt;0.347.0&gt; subscribe to Producer #PID&lt;0.340.0&gt; first&quot;</span><br><span class="line">&quot;Processor #PID&lt;0.348.0&gt; subscribe to Producer #PID&lt;0.341.0&gt; first&quot;</span><br><span class="line">&quot;Processor #PID&lt;0.349.0&gt; subscribe to Producer #PID&lt;0.337.0&gt; first&quot;</span><br><span class="line">&quot;Processor #PID&lt;0.350.0&gt; subscribe to Producer #PID&lt;0.339.0&gt; first&quot;</span><br><span class="line">&quot;Processor #PID&lt;0.351.0&gt; subscribe to Producer #PID&lt;0.339.0&gt; first&quot;</span><br><span class="line">&quot;Processor #PID&lt;0.352.0&gt; subscribe to Producer #PID&lt;0.334.0&gt; first&quot;</span><br><span class="line">&quot;Processor #PID&lt;0.353.0&gt; subscribe to Producer #PID&lt;0.341.0&gt; first&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.335.0&gt; from #PID&lt;0.344.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.339.0&gt; from #PID&lt;0.344.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.341.0&gt; from #PID&lt;0.344.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.335.0&gt; from #PID&lt;0.345.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.333.0&gt; from #PID&lt;0.344.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.335.0&gt; from #PID&lt;0.346.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.333.0&gt; from #PID&lt;0.345.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.339.0&gt; from #PID&lt;0.345.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.335.0&gt; from #PID&lt;0.347.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.341.0&gt; from #PID&lt;0.345.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.333.0&gt; from #PID&lt;0.346.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.342.0&gt; from #PID&lt;0.344.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.335.0&gt; from #PID&lt;0.348.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.339.0&gt; from #PID&lt;0.346.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.333.0&gt; from #PID&lt;0.347.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.341.0&gt; from #PID&lt;0.346.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.335.0&gt; from #PID&lt;0.349.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.333.0&gt; from #PID&lt;0.348.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.335.0&gt; from #PID&lt;0.350.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.342.0&gt; from #PID&lt;0.345.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.339.0&gt; from #PID&lt;0.347.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.333.0&gt; from #PID&lt;0.349.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.341.0&gt; from #PID&lt;0.347.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.338.0&gt; from #PID&lt;0.344.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.335.0&gt; from #PID&lt;0.351.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.337.0&gt; from #PID&lt;0.344.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.342.0&gt; from #PID&lt;0.346.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.336.0&gt; from #PID&lt;0.344.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.339.0&gt; from #PID&lt;0.348.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.333.0&gt; from #PID&lt;0.350.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.335.0&gt; from #PID&lt;0.352.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.340.0&gt; from #PID&lt;0.344.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.338.0&gt; from #PID&lt;0.345.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.341.0&gt; from #PID&lt;0.348.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.337.0&gt; from #PID&lt;0.345.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.342.0&gt; from #PID&lt;0.347.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.336.0&gt; from #PID&lt;0.345.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.339.0&gt; from #PID&lt;0.349.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.333.0&gt; from #PID&lt;0.351.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.341.0&gt; from #PID&lt;0.349.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.335.0&gt; from #PID&lt;0.353.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.342.0&gt; from #PID&lt;0.348.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.340.0&gt; from #PID&lt;0.345.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.338.0&gt; from #PID&lt;0.346.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.334.0&gt; from #PID&lt;0.344.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.337.0&gt; from #PID&lt;0.346.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.336.0&gt; from #PID&lt;0.346.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.333.0&gt; from #PID&lt;0.352.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.339.0&gt; from #PID&lt;0.350.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.338.0&gt; from #PID&lt;0.347.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.334.0&gt; from #PID&lt;0.345.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.340.0&gt; from #PID&lt;0.346.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.341.0&gt; from #PID&lt;0.350.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.337.0&gt; from #PID&lt;0.347.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.342.0&gt; from #PID&lt;0.349.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.333.0&gt; from #PID&lt;0.353.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.334.0&gt; from #PID&lt;0.346.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.338.0&gt; from #PID&lt;0.348.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.336.0&gt; from #PID&lt;0.347.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.341.0&gt; from #PID&lt;0.351.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.340.0&gt; from #PID&lt;0.347.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.342.0&gt; from #PID&lt;0.350.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.339.0&gt; from #PID&lt;0.351.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.337.0&gt; from #PID&lt;0.348.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.334.0&gt; from #PID&lt;0.347.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.336.0&gt; from #PID&lt;0.348.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.339.0&gt; from #PID&lt;0.352.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.341.0&gt; from #PID&lt;0.352.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.337.0&gt; from #PID&lt;0.349.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.342.0&gt; from #PID&lt;0.351.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.334.0&gt; from #PID&lt;0.348.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.338.0&gt; from #PID&lt;0.349.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.336.0&gt; from #PID&lt;0.349.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.341.0&gt; from #PID&lt;0.353.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.339.0&gt; from #PID&lt;0.353.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.342.0&gt; from #PID&lt;0.352.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.337.0&gt; from #PID&lt;0.350.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.340.0&gt; from #PID&lt;0.348.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.334.0&gt; from #PID&lt;0.349.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.338.0&gt; from #PID&lt;0.350.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.342.0&gt; from #PID&lt;0.353.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.336.0&gt; from #PID&lt;0.350.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.337.0&gt; from #PID&lt;0.351.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.334.0&gt; from #PID&lt;0.350.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.340.0&gt; from #PID&lt;0.349.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.338.0&gt; from #PID&lt;0.351.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.336.0&gt; from #PID&lt;0.351.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.340.0&gt; from #PID&lt;0.350.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.337.0&gt; from #PID&lt;0.352.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.334.0&gt; from #PID&lt;0.351.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.338.0&gt; from #PID&lt;0.352.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.336.0&gt; from #PID&lt;0.352.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.340.0&gt; from #PID&lt;0.351.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.337.0&gt; from #PID&lt;0.353.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.334.0&gt; from #PID&lt;0.352.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.336.0&gt; from #PID&lt;0.353.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.338.0&gt; from #PID&lt;0.353.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.340.0&gt; from #PID&lt;0.352.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.334.0&gt; from #PID&lt;0.353.0&gt;&quot;</span><br><span class="line">&quot;Subscribed #PID&lt;0.340.0&gt; from #PID&lt;0.353.0&gt;&quot;</span><br></pre></td></tr></table></figure>

<p>Once I send messages to RabbitMQ, we can see that every producer gets one message as expected.  But the <code>demands</code> list for every producer is the same, with the starting sequence of every consumer process.  Because the <code>demands</code> list across different Producer processes are the same at the beginning, the first batch of events are always distributed to the #1 Processor.  And this is also the observation documented in the experiment project Readme.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">iex(dev@localhost)1&gt; Foo.send_messages(10)</span><br><span class="line">&quot;Producer #PID&lt;0.342.0&gt; got one message.&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.340.0&gt; got one message.&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.337.0&gt; got one message.&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.333.0&gt; got one message.&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.334.0&gt; got one message.&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.335.0&gt; got one message.&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.336.0&gt; got one message.&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.338.0&gt; got one message.&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.339.0&gt; got one message.&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.341.0&gt; got one message.&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.342.0&gt; sends message to consumer #PID&lt;0.344.0&gt; out of [#PID&lt;0.345.0&gt;, #PID&lt;0.346.0&gt;, #PID&lt;0.347.0&gt;, #PID&lt;0.348.0&gt;, #PID&lt;0.349.0&gt;, #PID&lt;0.350.0&gt;, #PID&lt;0.351.0&gt;, #PID&lt;0.352.0&gt;, #PID&lt;0.353.0&gt;]&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.337.0&gt; sends message to consumer #PID&lt;0.344.0&gt; out of [#PID&lt;0.345.0&gt;, #PID&lt;0.346.0&gt;, #PID&lt;0.347.0&gt;, #PID&lt;0.348.0&gt;, #PID&lt;0.349.0&gt;, #PID&lt;0.350.0&gt;, #PID&lt;0.351.0&gt;, #PID&lt;0.352.0&gt;, #PID&lt;0.353.0&gt;]&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.340.0&gt; sends message to consumer #PID&lt;0.344.0&gt; out of [#PID&lt;0.345.0&gt;, #PID&lt;0.346.0&gt;, #PID&lt;0.347.0&gt;, #PID&lt;0.348.0&gt;, #PID&lt;0.349.0&gt;, #PID&lt;0.350.0&gt;, #PID&lt;0.351.0&gt;, #PID&lt;0.352.0&gt;, #PID&lt;0.353.0&gt;]&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.333.0&gt; sends message to consumer #PID&lt;0.344.0&gt; out of [#PID&lt;0.345.0&gt;, #PID&lt;0.346.0&gt;, #PID&lt;0.347.0&gt;, #PID&lt;0.348.0&gt;, #PID&lt;0.349.0&gt;, #PID&lt;0.350.0&gt;, #PID&lt;0.351.0&gt;, #PID&lt;0.352.0&gt;, #PID&lt;0.353.0&gt;]&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.334.0&gt; sends message to consumer #PID&lt;0.344.0&gt; out of [#PID&lt;0.345.0&gt;, #PID&lt;0.346.0&gt;, #PID&lt;0.347.0&gt;, #PID&lt;0.348.0&gt;, #PID&lt;0.349.0&gt;, #PID&lt;0.350.0&gt;, #PID&lt;0.351.0&gt;, #PID&lt;0.352.0&gt;, #PID&lt;0.353.0&gt;]&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.335.0&gt; sends message to consumer #PID&lt;0.344.0&gt; out of [#PID&lt;0.345.0&gt;, #PID&lt;0.346.0&gt;, #PID&lt;0.347.0&gt;, #PID&lt;0.348.0&gt;, #PID&lt;0.349.0&gt;, #PID&lt;0.350.0&gt;, #PID&lt;0.351.0&gt;, #PID&lt;0.352.0&gt;, #PID&lt;0.353.0&gt;]&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.336.0&gt; sends message to consumer #PID&lt;0.344.0&gt; out of [#PID&lt;0.345.0&gt;, #PID&lt;0.346.0&gt;, #PID&lt;0.347.0&gt;, #PID&lt;0.348.0&gt;, #PID&lt;0.349.0&gt;, #PID&lt;0.350.0&gt;, #PID&lt;0.351.0&gt;, #PID&lt;0.352.0&gt;, #PID&lt;0.353.0&gt;]&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.339.0&gt; sends message to consumer #PID&lt;0.344.0&gt; out of [#PID&lt;0.345.0&gt;, #PID&lt;0.346.0&gt;, #PID&lt;0.347.0&gt;, #PID&lt;0.348.0&gt;, #PID&lt;0.349.0&gt;, #PID&lt;0.350.0&gt;, #PID&lt;0.351.0&gt;, #PID&lt;0.352.0&gt;, #PID&lt;0.353.0&gt;]&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.338.0&gt; sends message to consumer #PID&lt;0.344.0&gt; out of [#PID&lt;0.345.0&gt;, #PID&lt;0.346.0&gt;, #PID&lt;0.347.0&gt;, #PID&lt;0.348.0&gt;, #PID&lt;0.349.0&gt;, #PID&lt;0.350.0&gt;, #PID&lt;0.351.0&gt;, #PID&lt;0.352.0&gt;, #PID&lt;0.353.0&gt;]&quot;</span><br><span class="line">&quot;Producer #PID&lt;0.341.0&gt; sends message to consumer #PID&lt;0.344.0&gt; out of [#PID&lt;0.345.0&gt;, #PID&lt;0.346.0&gt;, #PID&lt;0.347.0&gt;, #PID&lt;0.348.0&gt;, #PID&lt;0.349.0&gt;, #PID&lt;0.350.0&gt;, #PID&lt;0.351.0&gt;, #PID&lt;0.352.0&gt;, #PID&lt;0.353.0&gt;]&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;2&#x27;; has 3 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;3&#x27;; has 8 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;1&#x27;; has 7 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;6&#x27;; has 6 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;4&#x27;; has 5 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;5&#x27;; has 4 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;7&#x27;; has 3 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;10&#x27;; has 2 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;8&#x27;; has 1 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;9&#x27;; has 0 message(s) in its mailbox&quot;</span><br></pre></td></tr></table></figure>

<p>How can this happen?  My suspicion is that the messages in the mailbox of each Producer process are filled by the sequence of Processors’ startup sequence.  That mean even though every Processor tries to subscribe to the Producer randomly by shuffling the producer names, but each Producer still receives the subscription signal from Processor #1 firstly, and then #2, and then #3, and finally the #10.  </p>
<p>This phenomenon happens obviously when the batch size of the messages is equal to or smaller than the processor count.  But even if the batch size is much larger, say 50, beside the first 10 will be sent to the #1 processor, others will be biased to the processors started earlier.  I think the load could only be balanced after the system running for a while.  Below is the output (sorted) of the first batch of <code>50</code> messages.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;1&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;10&#x27;; has 3 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;2&#x27;; has 7 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;3&#x27;; has 8 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;4&#x27;; has 6 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;5&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;6&#x27;; has 2 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;7&#x27;; has 5 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;8&#x27;; has 1 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.344.0&gt; got &#x27;9&#x27;; has 4 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.345.0&gt; got &#x27;11&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.345.0&gt; got &#x27;12&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.345.0&gt; got &#x27;14&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.345.0&gt; got &#x27;17&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.345.0&gt; got &#x27;21&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.345.0&gt; got &#x27;26&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.345.0&gt; got &#x27;32&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.345.0&gt; got &#x27;39&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.345.0&gt; got &#x27;47&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.346.0&gt; got &#x27;13&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.346.0&gt; got &#x27;16&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.346.0&gt; got &#x27;18&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.346.0&gt; got &#x27;22&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.346.0&gt; got &#x27;27&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.346.0&gt; got &#x27;33&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.346.0&gt; got &#x27;40&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.346.0&gt; got &#x27;48&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.347.0&gt; got &#x27;15&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.347.0&gt; got &#x27;20&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.347.0&gt; got &#x27;25&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.347.0&gt; got &#x27;28&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.347.0&gt; got &#x27;34&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.347.0&gt; got &#x27;41&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.347.0&gt; got &#x27;49&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.348.0&gt; got &#x27;19&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.348.0&gt; got &#x27;24&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.348.0&gt; got &#x27;31&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.348.0&gt; got &#x27;35&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.348.0&gt; got &#x27;42&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.348.0&gt; got &#x27;50&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.349.0&gt; got &#x27;23&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.349.0&gt; got &#x27;30&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.349.0&gt; got &#x27;38&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.349.0&gt; got &#x27;43&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.350.0&gt; got &#x27;29&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.350.0&gt; got &#x27;36&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.350.0&gt; got &#x27;46&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.351.0&gt; got &#x27;37&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.351.0&gt; got &#x27;44&#x27;; has 0 message(s) in its mailbox&quot;</span><br><span class="line">&quot;processor #PID&lt;0.352.0&gt; got &#x27;45&#x27;; has 0 message(s) in its mailbox&quot;</span><br></pre></td></tr></table></figure>

<p><em>Update:</em> As per the discussion in <a target="_blank" rel="noopener" href="https://github.com/dashbitco/broadway/issues/269">issue raised in Broadway</a>, my suspicion is correct.  My PRs to GenStage and Broadway have fixed this issue.  :D</p>
  
	</div>
		<footer class="article-footer clearfix">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Sword/">Sword</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Elixir/">Elixir</a><a href="/tags/Source-Reading/">Source Reading</a>
  </div>


<div class="article-share" id="share">

  <div data-url="http://www.thinkingincrowd.me/2021/10/04/broadway-source-reading-part-5-subscription-and-concurrency/" data-title="Broadway Source Reading (Part 5 - Subscription &amp; Concurrency) | Thinking in Crowd / 鹄思乱想" data-tsina="kenspirit" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2022/09/04/Elixir-Module-AST-Inspect/" title="Elixir Module AST Inspect">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Elixir Module AST Inspect</span>
</a>
</div>


<div class="next">
<a href="/2021/07/16/broadway-source-reading-batching/"  title="Broadway Source Reading (Part 4 - Batching)">
 <strong>NEXT:</strong><br/> 
 <span>Broadway Source Reading (Part 4 - Batching)
</span>
</a>
</div>

</nav>

	<section class="comment">
	
  
    <div id="disqus_thread"></div>
  
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-the-subscription-is-done"><span class="toc-number">1.</span> <span class="toc-text">How the subscription is done?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Distribution-Logic-on-Biggest-Demand"><span class="toc-number">2.</span> <span class="toc-text">Distribution Logic on Biggest Demand</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unexpected-Subscription-and-Demand-Distribution"><span class="toc-number">3.</span> <span class="toc-text">Unexpected Subscription and Demand Distribution</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
			<li><a href="/categories/Life/" title="Life">Life<sup>7</sup></a></li>
		
			<li><a href="/categories/Psychology/" title="Psychology">Psychology<sup>21</sup></a></li>
		
			<li><a href="/categories/Sword/" title="Sword">Sword<sup>66</sup></a></li>
		
			<li><a href="/categories/Think/" title="Think">Think<sup>80</sup></a></li>
		
		</ul>
</div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/API/" style="font-size: 10px;">API</a> <a href="/tags/AWS/" style="font-size: 10.71px;">AWS</a> <a href="/tags/Ajax/" style="font-size: 10.71px;">Ajax</a> <a href="/tags/AngularJS/" style="font-size: 12.86px;">AngularJS</a> <a href="/tags/Architecture/" style="font-size: 10.71px;">Architecture</a> <a href="/tags/Asynchronous/" style="font-size: 10.71px;">Asynchronous</a> <a href="/tags/Attention/" style="font-size: 10px;">Attention</a> <a href="/tags/BTC/" style="font-size: 10px;">BTC</a> <a href="/tags/Babel/" style="font-size: 10px;">Babel</a> <a href="/tags/Belief/" style="font-size: 10.71px;">Belief</a> <a href="/tags/Bitcoin/" style="font-size: 10.71px;">Bitcoin</a> <a href="/tags/Blockchain/" style="font-size: 16.43px;">Blockchain</a> <a href="/tags/Blogging/" style="font-size: 10px;">Blogging</a> <a href="/tags/Book/" style="font-size: 12.86px;">Book</a> <a href="/tags/Bundling/" style="font-size: 10.71px;">Bundling</a> <a href="/tags/Business-Logic/" style="font-size: 11.43px;">Business Logic</a> <a href="/tags/Cache/" style="font-size: 10.71px;">Cache</a> <a href="/tags/Change/" style="font-size: 13.57px;">Change</a> <a href="/tags/Choice/" style="font-size: 10.71px;">Choice</a> <a href="/tags/Coach/" style="font-size: 10px;">Coach</a> <a href="/tags/Communication/" style="font-size: 12.86px;">Communication</a> <a href="/tags/Conflict/" style="font-size: 10px;">Conflict</a> <a href="/tags/Courage/" style="font-size: 10px;">Courage</a> <a href="/tags/DDD/" style="font-size: 10px;">DDD</a> <a href="/tags/Dapp/" style="font-size: 13.57px;">Dapp</a> <a href="/tags/Data-Modeling/" style="font-size: 10.71px;">Data Modeling</a> <a href="/tags/Database/" style="font-size: 10.71px;">Database</a> <a href="/tags/Death/" style="font-size: 10px;">Death</a> <a href="/tags/Delegation/" style="font-size: 10.71px;">Delegation</a> <a href="/tags/Design/" style="font-size: 11.43px;">Design</a> <a href="/tags/Destiny/" style="font-size: 11.43px;">Destiny</a> <a href="/tags/Distributed/" style="font-size: 12.14px;">Distributed</a> <a href="/tags/EOS/" style="font-size: 10px;">EOS</a> <a href="/tags/Education/" style="font-size: 10.71px;">Education</a> <a href="/tags/Elixir/" style="font-size: 17.14px;">Elixir</a> <a href="/tags/Emotion/" style="font-size: 10.71px;">Emotion</a> <a href="/tags/Empathy/" style="font-size: 11.43px;">Empathy</a> <a href="/tags/Ethereum/" style="font-size: 13.57px;">Ethereum</a> <a href="/tags/Excel/" style="font-size: 10px;">Excel</a> <a href="/tags/Experience/" style="font-size: 10.71px;">Experience</a> <a href="/tags/ExtJS/" style="font-size: 15px;">ExtJS</a> <a href="/tags/Father/" style="font-size: 10px;">Father</a> <a href="/tags/First-Principle/" style="font-size: 10.71px;">First Principle</a> <a href="/tags/Full-Stack/" style="font-size: 10px;">Full-Stack</a> <a href="/tags/Functional-Programming/" style="font-size: 14.29px;">Functional Programming</a> <a href="/tags/Goal/" style="font-size: 13.57px;">Goal</a> <a href="/tags/HTTPS/" style="font-size: 10px;">HTTPS</a> <a href="/tags/Habit/" style="font-size: 10.71px;">Habit</a> <a href="/tags/Health/" style="font-size: 10.71px;">Health</a> <a href="/tags/Idempotency/" style="font-size: 10.71px;">Idempotency</a> <a href="/tags/Influence/" style="font-size: 10px;">Influence</a> <a href="/tags/Integration/" style="font-size: 10px;">Integration</a> <a href="/tags/JSConf/" style="font-size: 10.71px;">JSConf</a> <a href="/tags/JSON/" style="font-size: 10.71px;">JSON</a> <a href="/tags/Jasmine/" style="font-size: 14.29px;">Jasmine</a> <a href="/tags/Javascript/" style="font-size: 20px;">Javascript</a> <a href="/tags/Kanban/" style="font-size: 14.29px;">Kanban</a> <a href="/tags/Leadership/" style="font-size: 11.43px;">Leadership</a> <a href="/tags/Learning/" style="font-size: 10.71px;">Learning</a> <a href="/tags/Love/" style="font-size: 10.71px;">Love</a> <a href="/tags/MVC/" style="font-size: 15px;">MVC</a> <a href="/tags/Management/" style="font-size: 14.29px;">Management</a> <a href="/tags/Mature/" style="font-size: 10px;">Mature</a> <a href="/tags/Maven/" style="font-size: 10.71px;">Maven</a> <a href="/tags/MicroServices/" style="font-size: 10px;">MicroServices</a> <a href="/tags/Milestone/" style="font-size: 10px;">Milestone</a> <a href="/tags/Mnesia/" style="font-size: 11.43px;">Mnesia</a> <a href="/tags/Mocha/" style="font-size: 10px;">Mocha</a> <a href="/tags/Mock/" style="font-size: 11.43px;">Mock</a> <a href="/tags/Modularization/" style="font-size: 10.71px;">Modularization</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Mood/" style="font-size: 12.14px;">Mood</a> <a href="/tags/Network/" style="font-size: 10px;">Network</a> <a href="/tags/Node-js/" style="font-size: 17.86px;">Node.js</a> <a href="/tags/OTP/" style="font-size: 10.71px;">OTP</a> <a href="/tags/Opportunity/" style="font-size: 10px;">Opportunity</a> <a href="/tags/POI/" style="font-size: 10px;">POI</a> <a href="/tags/Performance/" style="font-size: 10px;">Performance</a> <a href="/tags/Politics/" style="font-size: 10.71px;">Politics</a> <a href="/tags/Problem-Solving/" style="font-size: 11.43px;">Problem Solving</a> <a href="/tags/Productivity/" style="font-size: 11.43px;">Productivity</a> <a href="/tags/Programming/" style="font-size: 15.71px;">Programming</a> <a href="/tags/Promise/" style="font-size: 11.43px;">Promise</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/Relationship/" style="font-size: 18.57px;">Relationship</a> <a href="/tags/Responsibility/" style="font-size: 11.43px;">Responsibility</a> <a href="/tags/Retrospect/" style="font-size: 19.29px;">Retrospect</a> <a href="/tags/Risk/" style="font-size: 10px;">Risk</a> <a href="/tags/Rule/" style="font-size: 10px;">Rule</a> <a href="/tags/SPA/" style="font-size: 10px;">SPA</a> <a href="/tags/Scrum/" style="font-size: 10px;">Scrum</a> <a href="/tags/Security/" style="font-size: 10px;">Security</a> <a href="/tags/Server/" style="font-size: 10.71px;">Server</a> <a href="/tags/Sharing/" style="font-size: 10px;">Sharing</a> <a href="/tags/Smart-Contract/" style="font-size: 13.57px;">Smart Contract</a> <a href="/tags/Source-Reading/" style="font-size: 12.86px;">Source Reading</a> <a href="/tags/Startup/" style="font-size: 12.14px;">Startup</a> <a href="/tags/Statistics/" style="font-size: 10px;">Statistics</a> <a href="/tags/Supervisor/" style="font-size: 10.71px;">Supervisor</a> <a href="/tags/Support/" style="font-size: 10px;">Support</a> <a href="/tags/Time-Management/" style="font-size: 10.71px;">Time Management</a> <a href="/tags/Trip/" style="font-size: 11.43px;">Trip</a> <a href="/tags/Tutorial/" style="font-size: 15px;">Tutorial</a> <a href="/tags/TypeScript/" style="font-size: 10.71px;">TypeScript</a> <a href="/tags/UED/" style="font-size: 10px;">UED</a> <a href="/tags/UI/" style="font-size: 10px;">UI</a> <a href="/tags/Unit-Test/" style="font-size: 15px;">Unit Test</a> <a href="/tags/Visualization/" style="font-size: 10px;">Visualization</a> <a href="/tags/Wechat/" style="font-size: 15px;">Wechat</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> On the road to be a good father, husband, son and web developer, specialized in JS <br/>
			Playing around with Node.js, AngularJS.  Powering thinking through visualization.</p>
	</section>
	 
	<div class="social-font clearfix">
		
		<a href="http://weibo.com/kenspirit" target="_blank" title="weibo"></a>
		
		
		<a href="https://twitter.com/kenspirit" target="_blank" title="twitter"></a>
		
		
		<a href="https://github.com/kenspirit" target="_blank" title="github"></a>
		
		
		<a href="https://www.facebook.com/kenspirit" target="_blank" title="facebook"></a>
		
		
        <a href="https://www.linkedin.com/thinkingincrowd" target="_blank" title="linkedin"></a>
    
    
		  <script src='https://unpkg.com/mermaid@8.9.2/dist/mermaid.min.js'></script>
		  <script>
		    if (window.mermaid) {
		      mermaid.initialize({{ JSON.stringify(config.mermaid.options) }});
		    }
		  </script>
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2022 
		
		<a href="http://www.thinkingincrowd.me" target="_blank" title="鹄思乱想">鹄思乱想</a>
		
		</p>
</div>
</footer>
    
<script>
  var disqus_shortname = 'thinkingincrowd';
  
  var disqus_url = 'http://www.thinkingincrowd.me/2021/10/04/broadway-source-reading-part-5-subscription-and-concurrency/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>





<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-37378953-1', 'www.thinkingincrowd.me');  
ga('send', 'pageview');
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?796436d5d2646bb3157d9ac5bd7e7025";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </body>
</html>

