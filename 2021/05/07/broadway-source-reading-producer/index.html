
 <!DOCTYPE HTML>
<html >
<head>
  <script data-ad-client="ca-pub-3734008573442765" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <meta charset="UTF-8">
  
    <title>Broadway Source Reading (Part 2 - Producer) | Thinking in Crowd / 鹄思乱想</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="鹄思乱想">
    
    <meta name="description" content="After having an overview on the Broadway’s architecture, I want to know how the basic Broadway pipeline works with only Producer and Processor options">
    
    
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="kenspirit" />
    <meta name="twitter:title" content="Broadway Source Reading (Part 2 - Producer) | Thinking in Crowd / 鹄思乱想" />
      
    
    
    <link rel="alternate" href="/atom.xml" title="Thinking in Crowd / 鹄思乱想" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/qmark.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/qmark.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Thinking in Crowd / 鹄思乱想" title="Thinking in Crowd / 鹄思乱想"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Thinking in Crowd / 鹄思乱想">Thinking in Crowd / 鹄思乱想</a></h1>
				<h2 class="blog-motto">Swan flying in the immense sky</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/about">About</a></li>
					
						<li><a href="/algorithm">Algorithm</a></li>
					
						<li><a href="/kanban">Kanban</a></li>
					
						<li><a href="/nodeppt">Slideshare</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:www.thinkingincrowd.me">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2021/05/07/broadway-source-reading-producer/" title="Broadway Source Reading (Part 2 - Producer)" itemprop="url">Broadway Source Reading (Part 2 - Producer)</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://plus.google.com/108764880042816550000?rel=author" title="鹄思乱想" target="_blank" itemprop="author">鹄思乱想</a>
    </p>
  <p class="article-time">
    <time datetime="2021-05-07T15:45:55.000Z" itemprop="datePublished">May 7 2021</time>
    Updated:<time datetime="2022-08-28T08:07:15.454Z" itemprop="dateModified">Aug 28 2022</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Producer"><span class="toc-number">1.</span> <span class="toc-text">Producer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Initialization"><span class="toc-number">1.1.</span> <span class="toc-text">Initialization</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Message-Consumption"><span class="toc-number">2.</span> <span class="toc-text">Message Consumption</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pull-Proactive"><span class="toc-number">2.1.</span> <span class="toc-text">Pull (Proactive)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Push-Passive"><span class="toc-number">2.2.</span> <span class="toc-text">Push (Passive)</span></a></li></ol></li></ol>
		</div>
		
		<p>After having an overview on the <a href="http://www.thinkingincrowd.me/2021/03/30/broadway-source-reading-entry-and-architecture/">Broadway’s architecture</a>, I want to know how the basic Broadway pipeline works with only <code>Producer</code> and <code>Processor</code> options, such as this sample in the official Documentation:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">MyBroadway</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="title class_">Broadway</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start_link</span></span>(_opts) <span class="keyword">do</span></span><br><span class="line">    <span class="title class_">Broadway</span>.start_link(<span class="title class_">MyBroadway</span>,</span><br><span class="line">      <span class="symbol">name:</span> <span class="title class_">MyBroadwayExample</span>,</span><br><span class="line">      <span class="symbol">producer:</span> [</span><br><span class="line">        <span class="symbol">module:</span> &#123;<span class="title class_">Counter</span>, []&#125;,</span><br><span class="line">        <span class="symbol">concurrency:</span> <span class="number">1</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="symbol">processors:</span> [</span><br><span class="line">        <span class="symbol">default:</span> [<span class="symbol">concurrency:</span> <span class="number">2</span>]</span><br><span class="line">      ]</span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  ...callbacks...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>


<h2 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h2><p>As the beginning of the Broadway pipeline, the <code>producer</code> module should either keep generating events&#x2F;messages as the data source, or forwarding the queue messages that your Messaging Middleware receives from other external systems to downstream consumers.  </p>
<p>Broadway has provided officially-supported producers for Messaging Middleware like Amazon SQS, Apache Kafka, Google Cloud Pub&#x2F;Sub and RabbitMQ.  How do these producers work with Broadway?  What I need to know if I want to implement one for other Messaging Middlewares?</p>
<h3 id="Initialization"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization</h3><p>As shown in <a href="http://www.thinkingincrowd.me/2021/03/30/broadway-source-reading-entry-and-architecture/">Part 1 - Entry Point and Architecture</a>, <code>Topology.build_producers_specs/2</code> generates child specs of <code>ProducerStage</code> in the process supervision hierarchy.  The <code>ProducerStage</code> module which <code>use GenStage</code> acts as a wrapper of the producer module you specify in pipeline and delegates function calls to it, such as <code>handle_demand</code>, <code>handle_call</code>, <code>handle_cast</code>, <code>handle_info</code>, <code>prepare_for_draining</code> and <code>terminate</code>.  Its startup call sequence is:  </p>
<pre class="mermaid">sequenceDiagram
  participant S as Supervisor
  participant P as ProducerStage
  participant G as GenStage
  participant M as MyProducer

  S->>P: start_link(args, index, opts)
  P->>G: start_link(ProducerStage, {args, index}, opts)
  G->>G: init({ProducerStage, {args, index}})
  G-->>P: init({args, index})
  P->>M: init(my_producer_args_in_pipeline)
  M-->>G: {:producer, state, options}
  G->>G: init_producer(ProducerStage, options, state)</pre>


<h2 id="Message-Consumption"><a href="#Message-Consumption" class="headerlink" title="Message Consumption"></a>Message Consumption</h2><p>There are two approaches to consume messages in the Messaging Middlewares:  <strong>Pull</strong> and <strong>Push</strong>.  <strong>Pull</strong> is like you ask for tasks from your boss instead of your boss <strong>Push</strong> them to you. (Although in real life, you might have the opposite experience unless your company is using <a href="http://www.thinkingincrowd.me/2015/05/20/Dive-into-Kanban-1-What-is-it/">Kanban</a>.  :D)</p>
<p>For above mentioned Messaging Middlewares:  </p>
<ul>
<li>RabbitMQ is pushed-based.  </li>
<li>Amazon SQS, and Apache Kafka are pull-based.  </li>
<li>Google Cloud Pub&#x2F;Sub and can do both.</li>
</ul>
<p>Because <code>GenStage</code>‘s philosophy is <strong>Pull</strong>, how do two different message consuming models work with Broadway?  Let’s use the source code of Amazon SQS and RabbitMQ’s Broadway Producer to illustrate below.  </p>
<h3 id="Pull-Proactive"><a href="#Pull-Proactive" class="headerlink" title="Pull (Proactive)"></a>Pull (Proactive)</h3><pre class="mermaid">graph BT
  D(Amazon SQS Producer) -- pull --> C(Amazon SQS Queue)
  E(Processors in Broadway) -- pull --> D</pre>

<p>In the source code of <a target="_blank" rel="noopener" href="https://github.com/dashbitco/broadway_sqs/blob/78d32ba2d05ff6e9da3dc89948f91fd9d33299aa/lib/broadway_sqs/producer.ex#L214"><code>broadway_sqs/producer.ex</code></a>, the messages are to receive in the <code>handle_demand</code> callback because it’s the timing when consumers pulls for messages.  </p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@impl</span> <span class="literal">true</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_demand</span></span>(incoming_demand, %&#123;<span class="symbol">demand:</span> demand&#125; = state) <span class="keyword">do</span></span><br><span class="line">  handle_receive_messages(%&#123;state | <span class="symbol">demand:</span> demand + incoming_demand&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>handle_receive_messages</code> tries to get messages from SQS to meet the demand from consumers.  If the count of the messages is less than the demand, the producer schedules itself a signal to receive messages again until all demand is met.  </p>
<p>The messages received in scheduled task are handled in <code>handle_info</code> callback.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@impl</span> <span class="literal">true</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_info</span></span>(<span class="symbol">:receive_messages</span>, state) <span class="keyword">do</span></span><br><span class="line">  handle_receive_messages(%&#123;state | <span class="symbol">receive_timer:</span> <span class="literal">nil</span>&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Replying messages in <code>handle_demand</code> callback is not difficult to understand because that is where <code>GenStage</code> passes messages to consumers.  However, why <code>handle_info</code> can be used for the same purpose?  </p>
<p>In <code>GenStage</code>:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Catch-all messages</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_info</span></span>(msg, %&#123;<span class="symbol">state:</span> state&#125; = stage) <span class="keyword">do</span></span><br><span class="line">  noreply_callback(<span class="symbol">:handle_info</span>, [msg, state], stage)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## Shared helpers</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">noreply_callback</span></span>(<span class="symbol">:handle_info</span>, [msg, state], %&#123;<span class="symbol">mod:</span> mod&#125; = stage) <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> function_exported?(mod, <span class="symbol">:handle_info</span>, <span class="number">2</span>) <span class="keyword">do</span></span><br><span class="line">    handle_noreply_callback(mod.handle_info(msg, state), stage)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    log = <span class="string">&#x27;** Undefined handle_info in ~tp~n** Unhandled message: ~tp~n&#x27;</span></span><br><span class="line">    <span class="symbol">:error_logger</span>.warning_msg(log, [mod, msg])</span><br><span class="line">    &#123;<span class="symbol">:noreply</span>, %&#123;stage | <span class="symbol">state:</span> state&#125;&#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">handle_noreply_callback</span></span>(return, stage) <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">case</span> return <span class="keyword">do</span></span><br><span class="line">    &#123;<span class="symbol">:noreply</span>, events, state&#125; <span class="keyword">when</span> is_list(events) -&gt;</span><br><span class="line">      stage = dispatch_events(events, length(events), %&#123;stage | <span class="symbol">state:</span> state&#125;)</span><br><span class="line">      &#123;<span class="symbol">:noreply</span>, stage&#125;</span><br><span class="line"></span><br><span class="line">    &#123;<span class="symbol">:noreply</span>, events, state, <span class="symbol">:hibernate</span>&#125; <span class="keyword">when</span> is_list(events) -&gt;</span><br><span class="line">      stage = dispatch_events(events, length(events), %&#123;stage | <span class="symbol">state:</span> state&#125;)</span><br><span class="line">      &#123;<span class="symbol">:noreply</span>, stage, <span class="symbol">:hibernate</span>&#125;</span><br><span class="line"></span><br><span class="line">    &#123;<span class="symbol">:stop</span>, reason, state&#125; -&gt;</span><br><span class="line">      &#123;<span class="symbol">:stop</span>, reason, %&#123;stage | <span class="symbol">state:</span> state&#125;&#125;</span><br><span class="line"></span><br><span class="line">    other -&gt;</span><br><span class="line">      &#123;<span class="symbol">:stop</span>, &#123;<span class="symbol">:bad_return_value</span>, other&#125;, stage&#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>And in <code>ProducerStage</code>:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_info</span></span>(message, state) <span class="keyword">do</span></span><br><span class="line">  %&#123;<span class="symbol">module:</span> module, <span class="symbol">module_state:</span> module_state&#125; = state</span><br><span class="line"></span><br><span class="line">  message</span><br><span class="line">  |&gt; module.handle_info(module_state)</span><br><span class="line">  |&gt; handle_no_reply(state)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">handle_no_reply</span></span>(reply, %&#123;<span class="symbol">transformer:</span> transformer&#125; = state) <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">case</span> reply <span class="keyword">do</span></span><br><span class="line">    &#123;<span class="symbol">:noreply</span>, events, new_module_state&#125; <span class="keyword">when</span> is_list(events) -&gt;</span><br><span class="line">      messages = transform_events(events, transformer)</span><br><span class="line">      &#123;state, messages&#125; = maybe_rate_limit_and_buffer_messages(state, messages)</span><br><span class="line">      &#123;<span class="symbol">:noreply</span>, messages, %&#123;state | <span class="symbol">module_state:</span> new_module_state&#125;&#125;</span><br><span class="line"></span><br><span class="line">    &#123;<span class="symbol">:noreply</span>, events, new_module_state, <span class="symbol">:hibernate</span>&#125; -&gt;</span><br><span class="line">      messages = transform_events(events, transformer)</span><br><span class="line">      &#123;state, messages&#125; = maybe_rate_limit_and_buffer_messages(state, messages)</span><br><span class="line">      &#123;<span class="symbol">:noreply</span>, messages, %&#123;state | <span class="symbol">module_state:</span> new_module_state&#125;, <span class="symbol">:hibernate</span>&#125;</span><br><span class="line"></span><br><span class="line">    &#123;<span class="symbol">:stop</span>, reason, new_module_state&#125; -&gt;</span><br><span class="line">      &#123;<span class="symbol">:stop</span>, reason, %&#123;state | <span class="symbol">module_state:</span> new_module_state&#125;&#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>So the call sequence flow is:</p>
<pre class="mermaid">sequenceDiagram
  participant P as ProducerStage
  participant G as GenStage
  participant M as MyProducer

  G->>G: handle_info(msg, %{state: state} = stage)
  G->>G: noreply_callback(:handle_info, [msg, state], stage)
  G->>P: handle_info(message, %{module: module, module_state: module_state} = state)
  P->>M: handle_info(message, module_state)
  M-->>P: {:noreply, events, new_module_state}
  P->>P: handle_no_reply(reply, state)
  P-->>G: {:noreply, messages, %{state | module_state: new_module_state}}
  G->>G: handle_noreply_callback(return, stage)
  G->>G: dispatch_events(events, length(events), %{stage | state: state})</pre>

<p>As a result, the events returned from <code>handle_info</code> in our producer module will be dispatched to the consumers at the end.  </p>
<h3 id="Push-Passive"><a href="#Push-Passive" class="headerlink" title="Push (Passive)"></a>Push (Passive)</h3><pre class="mermaid">graph TD
  A(RabbitMQ Queue) -- push --> B(RabbitMQ Producer)
  C(Processors in Broadway) -- pull --> B</pre>

<p>According to this simple flow diagram, messages are pushed to the queue consumers if the queue has messages.  However, it’s possible that no broadway consumers ask for any message at that moment.  There are also times that the broadway consumers ask for messages but none have been pushed from queues.  How does the design fullfill these different scenarios?  </p>
<p>According to the source code of <a target="_blank" rel="noopener" href="https://github.com/dashbitco/broadway_rabbitmq/blob/ddd58d468d8d47b0487aea6a0f170cd3f82f03b8/lib/broadway_rabbitmq/producer.ex#L466">RabbitMQ Broadway Producer</a>, <code>handle_demand</code> does nothing.  </p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@impl</span> <span class="literal">true</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_demand</span></span>(_incoming_demand, state) <span class="keyword">do</span></span><br><span class="line">  &#123;<span class="symbol">:noreply</span>, [], state&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>As a result, demand request from consumers is ingored by the producer and the messages are always pushed from the producers.  In order to control Back-pressure for the consumers, option <code>:prefetch_count</code> is used in the producer to control the message volume.  The flow diagram should be this instead:  </p>
<pre class="mermaid">graph TD
  A(RabbitMQ Queue) -- push --> B(RabbitMQ Producer)
  B -- push --> C(Processors in Broadway)</pre>

<p>The underline logic is:  </p>
<ul>
<li><p>The Broadway RabbitMQ producer uses <code>:amqp</code> which uses <code>:amqp_client</code> to <a target="_blank" rel="noopener" href="https://github.com/dashbitco/broadway_rabbitmq/blob/ddd58d468d8d47b0487aea6a0f170cd3f82f03b8/lib/broadway_rabbitmq/producer.ex#L663">connect</a> to RabbitMQ, it calls the client’s <a target="_blank" rel="noopener" href="https://github.com/pma/amqp/blob/ddf3d1fae8a40a5e2edf4fa7afa3ef33eebe85f3/lib/amqp/basic.ex#L375">consume</a> method to register its process as a queue consumer.  </p>
</li>
<li><p>Every time a message is pushed from the queue, the producer’s process will receive message with structure <a target="_blank" rel="noopener" href="https://github.com/pma/amqp/blob/ddf3d1fae8a40a5e2edf4fa7afa3ef33eebe85f3/lib/amqp/basic.ex#L331"><code>&#123;:basic_deliver, payload, meta&#125;</code></a>.  </p>
</li>
<li><p>In the same way we explored above, the <code>handle_info</code> method of RabbitMQ producer returns the message for <code>GenStage</code> to dispatch.</p>
</li>
</ul>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_info</span></span>(&#123;<span class="symbol">:basic_deliver</span>, payload, meta&#125;, state) <span class="keyword">do</span></span><br><span class="line">  %&#123;<span class="symbol">channel:</span> channel, <span class="symbol">client:</span> client, <span class="symbol">config:</span> config&#125; = state</span><br><span class="line">  %&#123;<span class="symbol">delivery_tag:</span> tag, <span class="symbol">redelivered:</span> redelivered&#125; = meta</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Omitted some code for acknowledger here.</span></span><br><span class="line"></span><br><span class="line">  metadata =</span><br><span class="line">    meta</span><br><span class="line">    |&gt; <span class="title class_">Map</span>.take(config[<span class="symbol">:metadata</span>])</span><br><span class="line">    |&gt; <span class="title class_">Map</span>.put(<span class="symbol">:amqp_channel</span>, channel)</span><br><span class="line"></span><br><span class="line">  message = %<span class="title class_">Message</span>&#123;</span><br><span class="line">    <span class="symbol">data:</span> payload,</span><br><span class="line">    <span class="symbol">metadata:</span> metadata,</span><br><span class="line">    <span class="symbol">acknowledger:</span> acknowledger</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;<span class="symbol">:noreply</span>, [message], state&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Now we basically know how the producer receives and dispatches messages, we can move forward to the processors next.  </p>
  
	</div>
		<footer class="article-footer clearfix">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Sword/">Sword</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Elixir/">Elixir</a><a href="/tags/Source-Reading/">Source Reading</a>
  </div>


<div class="article-share" id="share">

  <div data-url="http://www.thinkingincrowd.me/2021/05/07/broadway-source-reading-producer/" data-title="Broadway Source Reading (Part 2 - Producer) | Thinking in Crowd / 鹄思乱想" data-tsina="kenspirit" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2021/06/19/broadway-source-reading-processor/" title="Broadway Source Reading (Part 3 - Processor)">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Broadway Source Reading (Part 3 - Processor)</span>
</a>
</div>


<div class="next">
<a href="/2021/03/30/broadway-source-reading-entry-and-architecture/"  title="Broadway Source Reading (Part 1 - Entry Point and Architecture)">
 <strong>NEXT:</strong><br/> 
 <span>Broadway Source Reading (Part 1 - Entry Point and Architecture)
</span>
</a>
</div>

</nav>

	<section class="comment">
	
  
    <div id="disqus_thread"></div>
  
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Producer"><span class="toc-number">1.</span> <span class="toc-text">Producer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Initialization"><span class="toc-number">1.1.</span> <span class="toc-text">Initialization</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Message-Consumption"><span class="toc-number">2.</span> <span class="toc-text">Message Consumption</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pull-Proactive"><span class="toc-number">2.1.</span> <span class="toc-text">Pull (Proactive)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Push-Passive"><span class="toc-number">2.2.</span> <span class="toc-text">Push (Passive)</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
			<li><a href="/categories/Life/" title="Life">Life<sup>7</sup></a></li>
		
			<li><a href="/categories/Psychology/" title="Psychology">Psychology<sup>21</sup></a></li>
		
			<li><a href="/categories/Sword/" title="Sword">Sword<sup>66</sup></a></li>
		
			<li><a href="/categories/Think/" title="Think">Think<sup>80</sup></a></li>
		
		</ul>
</div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/API/" style="font-size: 10px;">API</a> <a href="/tags/AWS/" style="font-size: 10.71px;">AWS</a> <a href="/tags/Ajax/" style="font-size: 10.71px;">Ajax</a> <a href="/tags/AngularJS/" style="font-size: 12.86px;">AngularJS</a> <a href="/tags/Architecture/" style="font-size: 10.71px;">Architecture</a> <a href="/tags/Asynchronous/" style="font-size: 10.71px;">Asynchronous</a> <a href="/tags/Attention/" style="font-size: 10px;">Attention</a> <a href="/tags/BTC/" style="font-size: 10px;">BTC</a> <a href="/tags/Babel/" style="font-size: 10px;">Babel</a> <a href="/tags/Belief/" style="font-size: 10.71px;">Belief</a> <a href="/tags/Bitcoin/" style="font-size: 10.71px;">Bitcoin</a> <a href="/tags/Blockchain/" style="font-size: 16.43px;">Blockchain</a> <a href="/tags/Blogging/" style="font-size: 10px;">Blogging</a> <a href="/tags/Book/" style="font-size: 12.86px;">Book</a> <a href="/tags/Bundling/" style="font-size: 10.71px;">Bundling</a> <a href="/tags/Business-Logic/" style="font-size: 11.43px;">Business Logic</a> <a href="/tags/Cache/" style="font-size: 10.71px;">Cache</a> <a href="/tags/Change/" style="font-size: 13.57px;">Change</a> <a href="/tags/Choice/" style="font-size: 10.71px;">Choice</a> <a href="/tags/Coach/" style="font-size: 10px;">Coach</a> <a href="/tags/Communication/" style="font-size: 12.86px;">Communication</a> <a href="/tags/Conflict/" style="font-size: 10px;">Conflict</a> <a href="/tags/Courage/" style="font-size: 10px;">Courage</a> <a href="/tags/DDD/" style="font-size: 10px;">DDD</a> <a href="/tags/Dapp/" style="font-size: 13.57px;">Dapp</a> <a href="/tags/Data-Modeling/" style="font-size: 10.71px;">Data Modeling</a> <a href="/tags/Database/" style="font-size: 10.71px;">Database</a> <a href="/tags/Death/" style="font-size: 10px;">Death</a> <a href="/tags/Delegation/" style="font-size: 10.71px;">Delegation</a> <a href="/tags/Design/" style="font-size: 11.43px;">Design</a> <a href="/tags/Destiny/" style="font-size: 11.43px;">Destiny</a> <a href="/tags/Distributed/" style="font-size: 12.14px;">Distributed</a> <a href="/tags/EOS/" style="font-size: 10px;">EOS</a> <a href="/tags/Education/" style="font-size: 10.71px;">Education</a> <a href="/tags/Elixir/" style="font-size: 17.14px;">Elixir</a> <a href="/tags/Emotion/" style="font-size: 10.71px;">Emotion</a> <a href="/tags/Empathy/" style="font-size: 11.43px;">Empathy</a> <a href="/tags/Ethereum/" style="font-size: 13.57px;">Ethereum</a> <a href="/tags/Excel/" style="font-size: 10px;">Excel</a> <a href="/tags/Experience/" style="font-size: 10.71px;">Experience</a> <a href="/tags/ExtJS/" style="font-size: 15px;">ExtJS</a> <a href="/tags/Father/" style="font-size: 10px;">Father</a> <a href="/tags/First-Principle/" style="font-size: 10.71px;">First Principle</a> <a href="/tags/Full-Stack/" style="font-size: 10px;">Full-Stack</a> <a href="/tags/Functional-Programming/" style="font-size: 14.29px;">Functional Programming</a> <a href="/tags/Goal/" style="font-size: 13.57px;">Goal</a> <a href="/tags/HTTPS/" style="font-size: 10px;">HTTPS</a> <a href="/tags/Habit/" style="font-size: 10.71px;">Habit</a> <a href="/tags/Health/" style="font-size: 10.71px;">Health</a> <a href="/tags/Idempotency/" style="font-size: 10.71px;">Idempotency</a> <a href="/tags/Influence/" style="font-size: 10px;">Influence</a> <a href="/tags/Integration/" style="font-size: 10px;">Integration</a> <a href="/tags/JSConf/" style="font-size: 10.71px;">JSConf</a> <a href="/tags/JSON/" style="font-size: 10.71px;">JSON</a> <a href="/tags/Jasmine/" style="font-size: 14.29px;">Jasmine</a> <a href="/tags/Javascript/" style="font-size: 20px;">Javascript</a> <a href="/tags/Kanban/" style="font-size: 14.29px;">Kanban</a> <a href="/tags/Leadership/" style="font-size: 11.43px;">Leadership</a> <a href="/tags/Learning/" style="font-size: 10.71px;">Learning</a> <a href="/tags/Love/" style="font-size: 10.71px;">Love</a> <a href="/tags/MVC/" style="font-size: 15px;">MVC</a> <a href="/tags/Management/" style="font-size: 14.29px;">Management</a> <a href="/tags/Mature/" style="font-size: 10px;">Mature</a> <a href="/tags/Maven/" style="font-size: 10.71px;">Maven</a> <a href="/tags/MicroServices/" style="font-size: 10px;">MicroServices</a> <a href="/tags/Milestone/" style="font-size: 10px;">Milestone</a> <a href="/tags/Mnesia/" style="font-size: 11.43px;">Mnesia</a> <a href="/tags/Mocha/" style="font-size: 10px;">Mocha</a> <a href="/tags/Mock/" style="font-size: 11.43px;">Mock</a> <a href="/tags/Modularization/" style="font-size: 10.71px;">Modularization</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Mood/" style="font-size: 12.14px;">Mood</a> <a href="/tags/Network/" style="font-size: 10px;">Network</a> <a href="/tags/Node-js/" style="font-size: 17.86px;">Node.js</a> <a href="/tags/OTP/" style="font-size: 10.71px;">OTP</a> <a href="/tags/Opportunity/" style="font-size: 10px;">Opportunity</a> <a href="/tags/POI/" style="font-size: 10px;">POI</a> <a href="/tags/Performance/" style="font-size: 10px;">Performance</a> <a href="/tags/Politics/" style="font-size: 10.71px;">Politics</a> <a href="/tags/Problem-Solving/" style="font-size: 11.43px;">Problem Solving</a> <a href="/tags/Productivity/" style="font-size: 11.43px;">Productivity</a> <a href="/tags/Programming/" style="font-size: 15.71px;">Programming</a> <a href="/tags/Promise/" style="font-size: 11.43px;">Promise</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/Relationship/" style="font-size: 18.57px;">Relationship</a> <a href="/tags/Responsibility/" style="font-size: 11.43px;">Responsibility</a> <a href="/tags/Retrospect/" style="font-size: 19.29px;">Retrospect</a> <a href="/tags/Risk/" style="font-size: 10px;">Risk</a> <a href="/tags/Rule/" style="font-size: 10px;">Rule</a> <a href="/tags/SPA/" style="font-size: 10px;">SPA</a> <a href="/tags/Scrum/" style="font-size: 10px;">Scrum</a> <a href="/tags/Security/" style="font-size: 10px;">Security</a> <a href="/tags/Server/" style="font-size: 10.71px;">Server</a> <a href="/tags/Sharing/" style="font-size: 10px;">Sharing</a> <a href="/tags/Smart-Contract/" style="font-size: 13.57px;">Smart Contract</a> <a href="/tags/Source-Reading/" style="font-size: 12.86px;">Source Reading</a> <a href="/tags/Startup/" style="font-size: 12.14px;">Startup</a> <a href="/tags/Statistics/" style="font-size: 10px;">Statistics</a> <a href="/tags/Supervisor/" style="font-size: 10.71px;">Supervisor</a> <a href="/tags/Support/" style="font-size: 10px;">Support</a> <a href="/tags/Time-Management/" style="font-size: 10.71px;">Time Management</a> <a href="/tags/Trip/" style="font-size: 11.43px;">Trip</a> <a href="/tags/Tutorial/" style="font-size: 15px;">Tutorial</a> <a href="/tags/TypeScript/" style="font-size: 10.71px;">TypeScript</a> <a href="/tags/UED/" style="font-size: 10px;">UED</a> <a href="/tags/UI/" style="font-size: 10px;">UI</a> <a href="/tags/Unit-Test/" style="font-size: 15px;">Unit Test</a> <a href="/tags/Visualization/" style="font-size: 10px;">Visualization</a> <a href="/tags/Wechat/" style="font-size: 15px;">Wechat</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> On the road to be a good father, husband, son and web developer, specialized in JS <br/>
			Playing around with Node.js, AngularJS.  Powering thinking through visualization.</p>
	</section>
	 
	<div class="social-font clearfix">
		
		<a href="http://weibo.com/kenspirit" target="_blank" title="weibo"></a>
		
		
		<a href="https://twitter.com/kenspirit" target="_blank" title="twitter"></a>
		
		
		<a href="https://github.com/kenspirit" target="_blank" title="github"></a>
		
		
		<a href="https://www.facebook.com/kenspirit" target="_blank" title="facebook"></a>
		
		
        <a href="https://www.linkedin.com/thinkingincrowd" target="_blank" title="linkedin"></a>
    
    
		  <script src='https://unpkg.com/mermaid@8.9.2/dist/mermaid.min.js'></script>
		  <script>
		    if (window.mermaid) {
		      mermaid.initialize({{ JSON.stringify(config.mermaid.options) }});
		    }
		  </script>
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2022 
		
		<a href="http://www.thinkingincrowd.me" target="_blank" title="鹄思乱想">鹄思乱想</a>
		
		</p>
</div>
</footer>
    
<script>
  var disqus_shortname = 'thinkingincrowd';
  
  var disqus_url = 'http://www.thinkingincrowd.me/2021/05/07/broadway-source-reading-producer/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>





<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-37378953-1', 'www.thinkingincrowd.me');  
ga('send', 'pageview');
</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8DKM4F4KH8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-8DKM4F4KH8');
</script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?796436d5d2646bb3157d9ac5bd7e7025";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </body>
</html>

