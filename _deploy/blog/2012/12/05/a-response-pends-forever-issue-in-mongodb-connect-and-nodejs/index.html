
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>A response pends forever issue in MongoDB, Connect and Node.js - Thinking in Crowd / 鹄思乱想</title>
  <meta name="author" content="鹄思乱想">

  
  <meta name="description" content="My ignorance
When I first switched to use connect-mongodb to replace the MemoryStore in Connect, I found that the homepage of my pet project cannot &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kenspirit.github.io/blog/2012/12/05/a-response-pends-forever-issue-in-mongodb-connect-and-nodejs/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Thinking in Crowd / 鹄思乱想" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37378953-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Thinking in Crowd / 鹄思乱想</a></h1>
  
    <h2>Swan flying in the immense sky</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kenspirit.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/tags">Tags</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">A Response Pends Forever Issue in MongoDB, Connect and Node.js</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-05T21:08:00+08:00" pubdate data-updated="true">Dec 5<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong>My ignorance</strong><br/>
When I first switched to use <a href="https://github.com/masylum/connect-mongodb">connect-mongodb</a> to replace the MemoryStore in <a href="https://github.com/senchalabs/connect">Connect</a>, I found that the homepage of my pet project cannot be even loaded and it seems the response is kept waiting there.  If I switched back to use MemoryStore, it&rsquo;s all fine.  There must be something wrong when I am using <a href="http://www.mongodb.org/">MongoDB</a> for session management.</p>

<p>First, I dig into the <em>session.js</em> in Connect.  Around line 267:</p>

<figure class='code'><figcaption><span>connect/lib/middleware/session.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// proxy end() to commit the session</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">;</span>
</span><span class='line'><span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="nx">end</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;saving&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">resetMaxAge</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;saved&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>After opening the debug feature in <a href="http://nodejs.org">Node</a>, I found that it&rsquo;s never going into the callback of <em>session.save()</em>.  Hence, the &lsquo;saved&rsquo; message is never printed in the console after &lsquo;saving&rsquo; and the response is never ending.</p>

<p>Why would this happened?  I kept tracing the code and found that <em>session.save()</em> in Connect is calling the <em>sessionStore.set()</em> method.  The <em>MongoStore.set()</em> method in <em>connect-mongodb.js</em> is just purely calling <em>collection.update()</em> and no much magic there.  However, it seems the <em>update()</em> method call has either no err and data coming back.  Is there something wrong with the MongoDB or the Collection?</p>

<p>MongoDB log doesn&rsquo;t seems to have any query or update action recorded and I just found that there are 10 connections started every time I started my app, but I remembered there were 5 connections (default pool size) before (Actually, I haven&rsquo;t noticed that this is the phenomenon of the problem I have at that time yet).</p>

<p>Without any clue, I checked the initialization of the MongoStore and find below code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">server_config</span><span class="p">.</span><span class="nx">isConnected</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">authenticateAndGetCollection</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">server_config</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Error connecting (&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">err</span> <span class="k">instanceof</span> <span class="nb">Error</span> <span class="o">?</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="o">:</span> <span class="nx">err</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">));</span>
</span><span class='line'>      <span class="nx">authenticateAndGetCollection</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It turns out that the flow goes into <em>server_config.connect()</em> again.  But why?  DB should be initialized in below code which is intended to encapsulate all DB operation.</p>

<figure class='code'><figcaption><span>DbManager.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">DbManager</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Db</span><span class="p">(</span><span class="s1">&#39;tyt&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">27017</span><span class="p">,</span> <span class="p">{</span><span class="nx">auto_reconnect</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="p">{}),</span> <span class="p">{</span><span class="nx">safe</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
</span><span class='line'>  <span class="nx">db</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(){});</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">getDb</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">db</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">})();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">DbManager</span> <span class="o">=</span> <span class="nx">DbManager</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>In my node app.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">,</span> <span class="nx">DbManager</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./db.js&#39;</span><span class="p">).</span><span class="nx">DbManager</span>
</span><span class='line'>  <span class="p">,</span> <span class="nx">mongoStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;connect-mongodb&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Configuration</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">secret</span><span class="o">:</span> <span class="s1">&#39;kenspirit&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;tt.sid&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">cookie</span><span class="o">:</span> <span class="p">{</span><span class="nx">secure</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">maxAge</span><span class="o">:</span> <span class="mi">300000</span><span class="p">},</span>
</span><span class='line'>      <span class="nx">store</span><span class="o">:</span> <span class="k">new</span> <span class="nx">mongoStore</span><span class="p">({</span><span class="nx">db</span><span class="o">:</span> <span class="nx">DbManager</span><span class="p">.</span><span class="nx">getDb</span><span class="p">()})</span>
</span><span class='line'>  <span class="p">}));</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are familiar with Node, you may have already noticed what I haven&rsquo;t done right here.  I am assuming the DB should be connected and ready for use already as I have called <em>db.open()</em> during DbManager&rsquo;s construction.  However, Async is the most importance concept in Node, <em>db.open()</em> takes my callback will immediately return and it doesn&rsquo;t guarantee it&rsquo;s opened already.  If I change to below code, problem solved.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">DbManager</span><span class="p">.</span><span class="nx">getDb</span><span class="p">();</span>
</span><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">secret</span><span class="o">:</span> <span class="s1">&#39;kenspirit&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;tt.sid&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">cookie</span><span class="o">:</span> <span class="p">{</span><span class="nx">secure</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">maxAge</span><span class="o">:</span> <span class="mi">300000</span><span class="p">},</span>
</span><span class='line'>      <span class="nx">store</span><span class="o">:</span> <span class="k">new</span> <span class="nx">mongoStore</span><span class="p">({</span><span class="nx">db</span><span class="o">:</span> <span class="nx">db</span><span class="p">})</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>The root of not responding</strong><br/>
I wonder where is the actual source to make the response kept waiting?  I have configured the <em>auto_reconnect</em> already.  Later I found that in mongodb:</p>

<figure class='code'><figcaption><span>mongodb/lib/mongodb/db.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">Db</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">_state</span> <span class="o">=</span> <span class="s1">&#39;connecting&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="p">{</span><span class="nx">firstCall</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Set that db has been closed</span>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">openCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// Return error from connection</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="c1">// Set the status of the server</span>
</span><span class='line'>      <span class="nx">self</span><span class="p">.</span><span class="nx">_state</span> <span class="o">=</span> <span class="s1">&#39;connected&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="c1">// Callback</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">self</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">Db</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_executeInsertCommand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db_command</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="c1">// If the pool is not connected, attemp to reconnect to send the message</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_state</span> <span class="o">==</span> <span class="s1">&#39;connecting&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">autoReconnect</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">commands</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span><span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="s1">&#39;db_command&#39;</span><span class="o">:</span><span class="nx">db_command</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="o">:</span><span class="nx">options</span><span class="p">,</span> <span class="s1">&#39;callback&#39;</span><span class="o">:</span><span class="nx">callback</span><span class="p">});</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>  <span class="p">;}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>mongodb/lib/connection/server.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">Server</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dbInstance</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="c1">// Force connection pool if there is one</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">connectionPool</span><span class="p">)</span> <span class="nx">server</span><span class="p">.</span><span class="nx">connectionPool</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="c1">// Create connection Pool instance with the current BSON serializer</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">connectionPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ConnectionPool</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">poolSize</span><span class="p">,</span> <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">bson</span><span class="p">,</span>  <span class="k">this</span><span class="p">.</span><span class="nx">socketOptions</span><span class="p">);</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="c1">// Set up on connect method</span>
</span><span class='line'>    <span class="nx">connectionPool</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;poolReady&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Create db command and Add the callback to the list of callbacks by the request id (mapping outgoing messages to correct callbacks)</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">db_command</span> <span class="o">=</span> <span class="nx">DbCommand</span><span class="p">.</span><span class="nx">NcreateIsMasterCommand</span><span class="p">(</span><span class="nx">dbInstance</span><span class="p">,</span> <span class="nx">dbInstance</span><span class="p">.</span><span class="nx">databaseName</span><span class="p">);</span>
</span><span class='line'>      <span class="c1">// Check out a reader from the pool</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">connectionPool</span><span class="p">.</span><span class="nx">checkoutConnection</span><span class="p">();</span>
</span><span class='line'>      <span class="c1">// Set server state to connEcted</span>
</span><span class='line'>      <span class="nx">server</span><span class="p">.</span><span class="nx">_serverState</span> <span class="o">=</span> <span class="s1">&#39;connected&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="c1">// dbInstance._state = &#39;connected&#39;;  If I add this line here, even if my code doesn&#39;t do any change, it works.</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, the root cause is found.  Normally, when <em>db.open()</em> is called, it sets its <em>_state = &lsquo;connecting&rsquo;</em>, and it then will call <em>server.connect()</em> to create connection pool and in the callback, it sets its <em>_state = &lsquo;connected&rsquo;</em> again.  However, my case is that the second call <em>server.connect()</em> in MongoStore.js first make the first connection pool stops and then creates a new connection pool again(This should be where makes the mongo db log has 10 connections opened).  Somehow, the callback in normal flow cannot be executed so that <em>db._state</em> has not been set to &lsquo;connected&rsquo;.  What is more, the callback set in <em>MongoStore.js</em> doesn&rsquo;t set the <em>db._state</em> to &lsquo;connected&rsquo;.  The <em>db._state</em> is remained in &lsquo;connecting&rsquo; forever which makes my update command keep pushing to its commands stack.</p>

<p><strong>Most appropriate way to initialize MongoDB and its connections in Node.js</strong><br/>
I began to wonder what is the &ldquo;most appropriate way&rdquo; to initialize MongoDB and manage its connections and googled around.</p>

<p>At first, I found a similar question asked in <a href="http://stackoverflow.com/questions/10656574/how-to-manage-mongodb-connections-in-a-nodejs-webapp">StackOverFlow</a>.<br/>
However, the reply doesn&rsquo;t seem to be reasonable.  It recommands opening a new connection (actually, a DB and Connection Pool there) per request.  And it said it&rsquo;s due to MongoDB is asynchronous.  It&rsquo;s pretty confusing and the asynchronous mechanism in Node should be achieved by callback instead of creating new connection per request.  If so, what is the point of using pool then?  This approach should be more slow.</p>

<p>Later I found out a reply from the author of node-mongodb-native in <a href="http://stackoverflow.com/questions/10307994/where-can-i-find-complete-documentation-concerning-node-mongodb-native/10349450#10349450">StackOverFlow</a> too.  It clearly stated &ldquo;DO NOT call open on each request.&rdquo;.</p>

<p>I believe only opening MongoDB once with appropriate pool size and initialize node application in the <em>db.open()</em> callback should be the right way to go.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">鹄思乱想</span></span>

      








  


<time datetime="2012-12-05T21:08:00+08:00" pubdate data-updated="true">Dec 5<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/sword/'>Sword</a>
  
</span>


      

<span class="tags">
  
    <a class='tag' href='/tags/connect/'>Connect</a>, <a class='tag' href='/tags/javascript/'>Javascript</a>, <a class='tag' href='/tags/mongodb/'>MongoDB</a>, <a class='tag' href='/tags/nodejs/'>NodeJS</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/10/27/db-design-for-multi-dimension-data/" title="Previous Post: 一个多维度数据匹配的RDBMS数据库表设计的想法">&laquo; 一个多维度数据匹配的RDBMS数据库表设计的想法</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/12/24/my-practices-on-time-management/" title="Next Post: My practices on Time Management">My practices on Time Management &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/11/13/callbacks-are-imperative/">回调函数是指令式的，Promise 是函数式的：Node 错失的最大机会</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/24/thanks-to-everyone-zach-lendon-github-angularjs/">Thanks to everyone, Zach Lendon, Github, AngularJS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/29/how-to-support-page-content-i18n-in-angularjs/">How to support page content i18n in AngularJS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/29/startup-review-network/">至关重要的关系</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/26/startup-review-permanent-beta/">永久测试之心, 寻求真我</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/14/function-definition-this-and-bind-in-javascript/">Function definition, this and bind in JavaScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/08/how-to-verify-json-data-with-angularjs-httpbackend/">How to verify JSON data with AngularJS $httpBackend</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/28/how-to-ask-share-and-influence/">一点点对提问，分享和影响力的看法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/25/review-on-book-inside-the-facebook/">打造 Facebook 读后感</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/16/can-i-make-13-billion-in-20-months/">我能否20个月赚130亿?</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/life'>Life (6)</a></li><li><a href='/blog/categories/sword'>Sword (20)</a></li><li><a href='/blog/categories/think'>Think (27)</a></li></ul>
</section>
<section>
  <h1>Tag Cloud</h1>
  <ul class="tag-cloud">
    <li><a style="font-size: 60%" href="/tags/amd/">AMD</a></li>
<li><a style="font-size: 60%" href="/tags/adapt/">Adapt</a></li>
<li><a style="font-size: 60%" href="/tags/ajax/">Ajax</a></li>
<li><a style="font-size: 122%" href="/tags/angularjs/">AngularJS</a></li>
<li><a style="font-size: 60%" href="/tags/blogging/">Blogging</a></li>
<li><a style="font-size: 114%" href="/tags/book/">Book</a></li>
<li><a style="font-size: 60%" href="/tags/callback/">Callback</a></li>
<li><a style="font-size: 87%" href="/tags/change/">Change</a></li>
<li><a style="font-size: 103%" href="/tags/coding/">Coding</a></li>
<li><a style="font-size: 60%" href="/tags/connect/">Connect</a></li>
<li><a style="font-size: 60%" href="/tags/db/">DB</a></li>
<li><a style="font-size: 87%" href="/tags/design/">Design</a></li>
<li><a style="font-size: 87%" href="/tags/destiny/">Destiny</a></li>
<li><a style="font-size: 87%" href="/tags/directive/">Directive</a></li>
<li><a style="font-size: 60%" href="/tags/excel/">Excel</a></li>
<li><a style="font-size: 60%" href="/tags/execution-context/">Execution context</a></li>
<li><a style="font-size: 129%" href="/tags/extjs/">ExtJs</a></li>
<li><a style="font-size: 60%" href="/tags/function-definition/">Function definition</a></li>
<li><a style="font-size: 60%" href="/tags/functional-programming/">Functional Programming</a></li>
<li><a style="font-size: 87%" href="/tags/gtd/">GTD</a></li>
<li><a style="font-size: 87%" href="/tags/goal/">Goal</a></li>
<li><a style="font-size: 60%" href="/tags/health/">Health</a></li>
<li><a style="font-size: 87%" href="/tags/httpbackend/">HttpBackend</a></li>
<li><a style="font-size: 60%" href="/tags/influence/">Influence</a></li>
<li><a style="font-size: 60%" href="/tags/jawr/">JAWR</a></li>
<li><a style="font-size: 87%" href="/tags/json/">JSON</a></li>
<li><a style="font-size: 129%" href="/tags/jasmine/">Jasmine</a></li>
<li><a style="font-size: 165%" href="/tags/javascript/">Javascript</a></li>
<li><a style="font-size: 129%" href="/tags/management/">Management</a></li>
<li><a style="font-size: 87%" href="/tags/maven/">Maven</a></li>
<li><a style="font-size: 103%" href="/tags/mock/">Mock</a></li>
<li><a style="font-size: 60%" href="/tags/modularization/">Modularization</a></li>
<li><a style="font-size: 60%" href="/tags/mongodb/">MongoDB</a></li>
<li><a style="font-size: 114%" href="/tags/mood/">Mood</a></li>
<li><a style="font-size: 60%" href="/tags/network/">Network</a></li>
<li><a style="font-size: 114%" href="/tags/nodejs/">NodeJS</a></li>
<li><a style="font-size: 60%" href="/tags/opportunity/">Opportunity</a></li>
<li><a style="font-size: 60%" href="/tags/poi/">POI</a></li>
<li><a style="font-size: 60%" href="/tags/performance/">Performance</a></li>
<li><a style="font-size: 60%" href="/tags/permanent/">Permanent</a></li>
<li><a style="font-size: 60%" href="/tags/pomodoro/">Pomodoro</a></li>
<li><a style="font-size: 87%" href="/tags/productivity/">Productivity</a></li>
<li><a style="font-size: 60%" href="/tags/promise/">Promise</a></li>
<li><a style="font-size: 159%" href="/tags/retrospect/">Retrospect</a></li>
<li><a style="font-size: 60%" href="/tags/risk/">Risk</a></li>
<li><a style="font-size: 60%" href="/tags/spa/">SPA</a></li>
<li><a style="font-size: 60%" href="/tags/share/">Share</a></li>
<li><a style="font-size: 103%" href="/tags/startup/">Startup</a></li>
<li><a style="font-size: 60%" href="/tags/string-interpolation/">String interpolation</a></li>
<li><a style="font-size: 60%" href="/tags/stuff/">Stuff</a></li>
<li><a style="font-size: 87%" href="/tags/time-management/">Time Management</a></li>
<li><a style="font-size: 103%" href="/tags/trip/">Trip</a></li>
<li><a style="font-size: 60%" href="/tags/ued/">UED</a></li>
<li><a style="font-size: 60%" href="/tags/ui/">UI</a></li>
<li><a style="font-size: 129%" href="/tags/unittest/">UnitTest</a></li>
<li><a style="font-size: 60%" href="/tags/webassemble/">Webassemble</a></li>
<li><a style="font-size: 60%" href="/tags/weblogic/">Weblogic</a></li>
<li><a style="font-size: 60%" href="/tags/bind/">bind</a></li>
<li><a style="font-size: 87%" href="/tags/i18n/">i18n</a></li>
<li><a style="font-size: 60%" href="/tags/ngclass/">ngClass</a></li>
<li><a style="font-size: 60%" href="/tags/ngrepeat/">ngRepeat</a></li>
<li><a style="font-size: 60%" href="/tags/this/">this</a></li>

  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/kenspirit">@kenspirit</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'kenspirit',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
    <h1>Weibo</h1>
    <iframe id="sina_widget_1730265332" style="width:100%; height:500px;" frameborder="0" scrolling="no" src="http://v.t.sina.com.cn/widget/widget_blog.php?uid=1730265332&height=500&skin=wd_01&showpic=1"></iframe>
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/chengusky@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - 鹄思乱想 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'thinkingincrowd';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://kenspirit.github.io/blog/2012/12/05/a-response-pends-forever-issue-in-mongodb-connect-and-nodejs/';
        var disqus_url = 'http://kenspirit.github.io/blog/2012/12/05/a-response-pends-forever-issue-in-mongodb-connect-and-nodejs/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
